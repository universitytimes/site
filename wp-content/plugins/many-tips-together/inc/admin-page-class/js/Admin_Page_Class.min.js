/**
 * Aadmin pages class
 *
 * JS used for the admin pages class and other form items.
 *
 * Copyright 2011 Ohad Raz (admin@bainternet.info)
 * @since 1.0
 */

function apc_init(){load_code_editor();fancyCheckbox();fancySelect();$(".at-re-toggle").live("click",function(){$(this).prev().toggle("slow")});loadDatePicker();loadTimePicker();loadColorPicker();$(".at-add-file").click(function(){var e=$(this).parent().find(".file-input:first");e.clone().insertAfter(e).show();return false});$(".at-upload").delegate(".at-delete-file","click",function(){var e=$(this),t=e.parent(),n=e.attr("rel");$.post(ajaxurl,{action:"at_delete_file",data:n},function(e){e=="0"?(alert("File has been successfully deleted."),t.remove()):alert("You do NOT have permission to delete this file.")});return false});$(".repeater-sortable").sortable();$(".at-sortable").sortable({placeholder:"ui-state-highlight"});load_images_muploader();$(".at-delete_image_button").live("click",function(e){e.preventDefault();remove_image($(this));return false});$(".at-upload_image_button").live("click",function(e){e.preventDefault();image_upload($(this));return false});$("#apc_import_b").live("click",function(){do_ajax_import_export("import")});$("#apc_export_b").live("click",function(){do_ajax_import_export("export")});$("#apc_refresh_page_b").live("click",function(){refresh_page()});$('[data-dismiss="alert"]').live("click",function(){$(this).parent().remove()})}function loadColorPicker(){if($.farbtastic){$(".at-color").live("focus",function(){e($(this).next())});$(".at-color").live("focusout",function(){t($(this).next())});$(".at-color-select").live("click",function(){if($(this).next("div").css("display")=="none")e($(this));else t($(this))});function e(e){colorPicker=$(e).next("div");input=$(e).prev("input");$.farbtastic($(colorPicker),function(e){$(input).val(e).css("background",e)});colorPicker.show()}function t(e){colorPicker=$(e).next("div");$(colorPicker).hide()}$(".at-color").each(function(){var e=$(this).val();if(e.length==7)$(this).css("background",e)})}else{if($(".at-color-iris").length>0){$(".at-color-iris").wpColorPicker()}}}function loadDatePicker(){$(".at-date").each(function(){var e=$(this),t=e.attr("rel");e.datepicker({showButtonPanel:true,dateFormat:t})})}function loadTimePicker(){$(".at-time").each(function(){var e=$(this),t=e.attr("rel");e.timepicker({showSecond:true,timeFormat:t})})}function fancyCheckbox(){$(":checkbox").each(function(){var e=$(this);if(!e.hasClass("no-toggle")){e.FancyCheckbox();if(e.hasClass("conditinal_control")){e.live("change",function(){var e=$(this);if(e.is(":checked"))e.next().next().show("fast");else e.next().next().hide("fast")})}}else{if(e.hasClass("conditinal_control")){e.live("change",function(){var e=$(this);if(e.is(":checked"))e.next().show("fast");else e.next().hide("fast")})}}})}function fancySelect(){$("select").each(function(){if(!$(this).hasClass("no-fancy"))$(this).select2()})}function remove_image(e){var t=$(e);var n=t.attr("rel");var r=t.prev().prev();var i=t.prev();var s=t;data={action:"apc_delete_mupload",_wpnonce:$("#nonce-delete-mupload_"+n).val(),field_id:n,attachment_id:jQuery(r).val()};$.getJSON(ajaxurl,data,function(e){if("success"==e.status){$(s).val("Upload Image");$(s).removeClass("at-delete_image_button").addClass("at-upload_image_button");$(r).val("");$(i).val("");$(r).prev().html("");load_images_muploader()}else{alert(e.message)}})}function image_upload(e){var t=$(e);formfield1=t.prev();formfield2=t.prev().prev();if(t.attr("data-u")=="tk"){tb_show("","media-upload.php?post_id=0&type=image&apc=apc&TB_iframe=true");window.restore_send_to_editor=window.send_to_editor;window.send_to_editor=function(e){imgurl=$("img",e).attr("src");img_calsses=$("img",e).attr("class").split(" ");att_id="";$.each(img_calsses,function(e,t){if(t.indexOf("wp-image")!=-1){att_id=t.replace("wp-image-","")}});$(formfield2).val(att_id);$(formfield1).val(imgurl);load_images_muploader();tb_remove();window.send_to_editor=window.restore_send_to_editor}}else{if(file_frame){file_frame.open();return}file_frame=wp.media.frames.file_frame=wp.media({title:t.data("uploader_title"),button:{text:t.data("uploader_button_text")},multiple:false});file_frame.on("select",function(){attachment=file_frame.state().get("selection").first().toJSON();jQuery(formfield2).val(attachment.id);jQuery(formfield1).val(attachment.url);load_images_muploader()});file_frame.open()}}function load_images_muploader(){$(".mupload_img_holder").each(function(e,t){if($(this).next().next().val()!=""){if(!$(this).children().size()>0){var n=$(this).attr("data-he");var r=$(this).attr("data-wi");$(this).append('<img src="'+$(this).next().next().val()+'" style="height: '+n+";width: "+r+';" />');$(this).next().next().next().val("Delete");$(this).next().next().next().removeClass("at-upload_image_button").addClass("at-delete_image_button")}}})}function load_code_editor(){var e=0;$(".code_text").each(function(){var t=$(this).attr("data-lang");switch(t){case"php":t="application/x-httpd-php";break;case"less":case"css":t="text/css";break;case"html":t="text/html";break;case"javascript":t="text/javascript";break;default:t="application/x-httpd-php"}var n=$(this).attr("data-theme");switch(n){case"default":n="default";break;case"light":n="solarizedLight";break;case"dark":n="solarizedDark";break;default:n="default"}var r=CodeMirror.fromTextArea(document.getElementById($(this).attr("id")),{lineNumbers:true,matchBrackets:true,mode:t,indentUnit:4,indentWithTabs:true,enterMode:"keep",tabMode:"shift"});r.setOption("theme",n);$(r.getScrollerElement()).width(100);width=$(r.getScrollerElement()).parent().width();$(r.getScrollerElement()).width(width);r.refresh();Ed_array[e]=r;e++})}function do_ajax_import_export(e){before_ajax_import_export(e);var t=jQuery("#option_group_name").val();var n="#apc_"+e+"_nonce";var r="apc_"+e+"_"+t;jQuery.ajaxSetup({cache:false});if(e=="export")export_ajax_call(r,t,n,e);else import_ajax_call(r,t,n,e);jQuery.ajaxSetup({cache:true})}function export_ajax_call(e,t,n,r){jQuery.getJSON(ajaxurl,{group:t,rnd:microtime(false),action:e,seq:jQuery(n).val()},function(e){if(e){export_response(e)}else{alert("Something Went Wrong, try again later")}after_ajax_import_export(r)})}function import_ajax_call(e,t,n,r){jQuery.post(ajaxurl,{group:t,rnd:microtime(false),action:e,seq:jQuery(n).val(),imp:jQuery("#import_code").val()},function(e){if(e){import_response(e)}else{alert("Something Went Wrong, try again later")}after_ajax_import_export(r)},"json")}function before_ajax_import_export(e){jQuery(".import_status").hide("fast");jQuery(".export_status").hide("fast");jQuery(".export_results").html("").removeClass("alert-success").hide();jQuery(".import_results").html("").removeClass("alert-success").hide();if(e=="import")jQuery(".import_status").show("fast");else jQuery(".export_status").show("fast")}function after_ajax_import_export(e){if(e=="import")jQuery(".import_status").hide("fast");else jQuery(".export_status").hide("fast")}function export_response(e){if(e.code)jQuery("#export_code").val(e.code);if(e.nonce)jQuery("#apc_export_nonce").val(e.nonce);if(e.err)jQuery(".export_results").html(e.err).show("slow")}function import_response(e){if(e.nonce)jQuery("#apc_import_nonce").val(e.nonce);if(e.err)jQuery(".import_results").html(e.err);if(e.success)jQuery(".import_results").html(e.success).addClass("alert-success").show("slow")}function refresh_page(){location.reload()}function microtime(e){var t=(new Date).getTime()/1e3;var n=parseInt(t);return e?t:Math.round((t-n)*1e3)/1e3+" "+n}function get_query_var(e){var t=RegExp("[?&]"+e+"=([^&#]*)").exec(location.href);return t&&decodeURIComponent(t[1].replace(/\+/g," "))}var $=jQuery.noConflict();var Ed_array=Array;var formfield1;var formfield2;var file_frame;jQuery(document).ready(function(e){apc_init();e(window).resize(function(){e.each(Ed_array,function(){var t=this;e(t.getScrollerElement()).width(100);width=e(t.getScrollerElement()).parent().width();e(t.getScrollerElement()).width(width);t.refresh()})})})